@page "{recipeId?}"
@model Recipes.Pages.MenuRecipes.EditModel
@{
}

<h1>@Model.FormTitle</h1>
@Html.AntiForgeryToken()
<form id="form" method="post">
    <input type="hidden" asp-for="Recipe.Id" />
    <div class="form-group">
        <label asp-for="Recipe.Name"></label>
        <input asp-for="Recipe.Name" class="form-control" />
        <span class="text-danger" asp-validation-for="Recipe.Name"></span>
        <label asp-for="Recipe.CookTimeMinutes"></label>
        <input asp-for="Recipe.CookTimeMinutes" class="form-control" pattern="[0-9]{10}" />
        <span class="text-danger" asp-validation-for="Recipe.CookTimeMinutes"></span>
        <label asp-for="Recipe.Servings"></label>
        <input asp-for="Recipe.Servings" class="form-control" type="number" min="1" />
        <span class="text-danger" asp-validation-for="Recipe.Servings"></span>
        @*<div id="ingredientItemsContainer">
                <partial name="_Ingredient" model="Model.Recipe" />
            </div>*@
        @*<div id="testDiv"></div>*@
  

        <ul style="list-style-type:disc">
    
            @*@foreach (var ingredient in Model.Recipe.Ingredients)
            {
                <li>@ingredient</li>
            }*@
        </ul>
        <table id="tableIngredients" class="table">
            <thead>
                <tr>
                    <th>Ingredients</th>
                    @*<th>Edit</th>
                    <th>Delete</th>*@
               </tr>
            </thead>
            <tbody>
                @foreach (var ingredient in Model.Recipe.Ingredients)
                {
                <tr>
                    <td>@ingredient</td>
                    @*<td><a href="" class="editor_edit">Edit</a></td>
                    <td><a href="" class="editor_remove">Delete</a></td>*@
                    <td>
                        <button class="btn btn-primary edit-button" data-id="@ingredient">Edit</button>
                    </td>
                </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td>
                        <input type="text" id="IngredientToAdd" class="form-control" />
                    </td>
                    <td>
                        <input class="btn btn-default" type="button" id="btnAddIngredient" value="Add ingredient" onclick="AddIngredient()" />
                    </td>
                </tr>
            </tfoot>
        </table>
        @*<label asp-for="Recipe.Directions"></label>
            <ol>
                @foreach (var direction in Model.Recipe.Directions)
                {
                    <li>@direction</li>
                }
            </ol>*@

        <select id="CategoryId" name="CategoryId" asp-for="Recipe.CategoryId" asp-items="Model.Categories"></select>
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
</form>


<a asp-page="./List" class="btn btn-default">All Recipes</a>

@section Scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script type="text/javascript">

    $(document).ready(function () {

        $('#tableIngredients').DataTable();
            @*$('#tableIngredients').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    url: '@Url.Page("Edit","AddIngredientItem")',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': $('@Html.AntiForgeryToken()').val() }
                }
            });*@
    });


    function UndoUpdateIngredient() {
        //e.preventtDefault();
        //alert($("#Ingredients").val());
        location.href = "";
    }

    function AddIngredient() {
        let ingredientToAdd = $("#IngredientToAdd").val();
        //alert($("#IngredientToAdd").val());
         $.ajax({
                type: "GET",
                //dataType:'json',
                data: { ingredientToAdd },
                //traditional: true,
                contentType: "application/json; charset=utf-8",
                url: '@Url.Page("Edit","AddIngredient")',
                success: function (result) {
                    alert(result);
                }
            });
    }


    //$('#tableIngredients').on('click', 'a.editor_edit', function (e) {
    //    e.preventDefault();

    //    alert('edit');

    //    //editor.editor($(this).closest('tr'), {
    //    //    title: 'Edit record',
    //    //    buttons: 'Update'
    //    //});
    //});

    //var ingredientsTable = $('#tableIngredients').DataTable();

    //$('#tableIngredients').on('click', 'tbody tr', function () {
    //    $('#tableIngredients').DataTable().row(this).edit({
    //        buttons: [
    //            { label: 'Cancel', fn: function () { this.close(); } },
    //              'Edit'
    //        ]
    //    });
    //});

    $('.edit-button').click(function (e) {
        e.preventDefault();
        let id = this.dataset.id;

        $(this).closest('tr').find('td').each(function (index, value) {
            //alert(id);
            //alert(index);
            if (index < inputNames.length) {
                let text = $(value).text().trim();
                let name = inputNames[index];
                $(value).append('<input type="text" name="' + name + '" id="' + name + '" class="form-control" value="' + text + '" />');
                $(value).find('span').remove();
            }
            else {
                //alert('On Save');
                $(value).find('button').remove();
                $(value).append('<input type="submit" value="Save" name="Save" class="btn btn-primary" />');
                $(value).append('&nbsp;<input type="button" value="Cancel" onclick="UndoUpdateIngredient();" name="Cancel" class="btn btn-primary" />');
                $(value).append('<input type="hidden" name="IngredientOriginal" value="' + id + '" />');
            }
        });
    })


    var inputNames = [];
    $('.table > thead > tr > th').each(function (index, value) {
        if ($(value).text().trim() != "") {
            inputNames.push($(value).text().trim());
        }
    });

    @*$("#btnAddIngredient").on('click', function () {
            let recipe = $('#form').serialize();
            //recipe.Name = 'Test';
            //recipe.Ingredients = ['aa', 'bb', 'cc'];
            let test = ["aa", "bb", "cc"];
            $.ajax({
                type: "GET",
                //dataType:'json',
                data: { test },
                traditional: true,
                //data: { test },
                contentType: "application/json; charset=utf-8",
                url: '@Url.Page("Edit","AddIngredientItem")',//"/MenuRecipes/Edit?handler=AddIngredientItem",
                success: function (partialView) {
                    console.log("partialView: " + partialView);
                    $("#testDiv").html(partialView)
                }
            });
        });*@
</script>
}
